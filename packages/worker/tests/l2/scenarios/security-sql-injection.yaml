# L2 Scenario: Fix Critical SQL Injection Vulnerability
# 
# This is a COMPLEX security scenario that requires:
# 1. Identifying SQL injection in multiple files
# 2. Understanding the data flow from API to database
# 3. Implementing proper parameterized queries
# 4. Adding input validation
# 5. Writing security tests
#
name: security-sql-injection
level: L2
type: bug_fix
mode: mechanic

setup:
  repo: fullstack-api

input:
  goal: |
    CRITICAL SECURITY FIX: There are SQL injection vulnerabilities in the codebase.
    
    1. Find all SQL injection vulnerabilities in src/db/connection.ts
    2. The getUser function is vulnerable - it uses string interpolation
    3. Fix by using parameterized queries ($1, $2, etc)
    4. Add input validation in src/utils/validation.ts for user IDs
    5. Update the API routes in src/api/users.ts to validate input
    6. Add a test case that verifies SQL injection is prevented
    
    The fix must:
    - Use parameterized queries for ALL database calls
    - Validate that user IDs are valid UUIDs before querying
    - Return 400 Bad Request for invalid input (not 500)
    
  constraints:
    stepCap: 30
    tokenCap: 80000
    timeLimitMs: 180000

mockResponses:
  scenario: security-complex

expectations:
  max_steps: 25
  must_call:
    - read_file
    - apply_patch
    - run_tests
    - commit_changes
  must_not_call: []
  final_status: succeeded
  patch_contains: "$1"
  tests_pass: true

