name: Full Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run L3 tests nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to run (l0, l1, l2, l3, l4, all)'
        required: false
        default: 'all'
      include_chaos:
        description: 'Include chaos tests'
        required: false
        default: 'false'

env:
  DATABASE_URL: postgres://postgres:testpassword@localhost:5432/ai_coding_team_test

jobs:
  # =============================================================================
  # L0 & L1 - Infrastructure and Tool Tests
  # =============================================================================
  l0-l1:
    name: L0/L1 - Infrastructure & Tools
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: ai_coding_team_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Run migrations
        run: pnpm db:migrate

      - name: Build packages
        run: pnpm build

      - name: Run L0 Tests
        run: pnpm test:l0

      - name: Run L1 Tests
        run: pnpm test:l1

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: l0-l1-results
          path: |
            **/test-results.json
            **/*.log

  # =============================================================================
  # L2 - Agent Loop Tests
  # =============================================================================
  l2:
    name: L2 - Agent Loop
    runs-on: ubuntu-latest
    needs: l0-l1
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: ai_coding_team_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build mock LLM
        run: |
          cd testing/mock-llm
          npm install

      - name: Start mock LLM
        run: |
          cd testing/mock-llm
          npm start &
          sleep 5

      - name: Run migrations
        run: pnpm db:migrate

      - name: Build packages
        run: pnpm build

      - name: Run L2 Tests
        run: pnpm test:l2
        env:
          MOCK_LLM_URL: http://localhost:8000

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: l2-results
          path: |
            **/test-results.json
            **/*.log

  # =============================================================================
  # L3 - E2E Batch Tests (Nightly or Manual)
  # =============================================================================
  l3:
    name: L3 - E2E Batch
    runs-on: ubuntu-latest
    needs: l2
    if: github.event_name == 'schedule' || github.event.inputs.test_level == 'l3' || github.event.inputs.test_level == 'all'
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Start L3 test environment
        run: |
          docker compose -f docker-compose.l3.yml up -d
          sleep 30  # Wait for services to be ready

      - name: Run L3 Batch Tests
        run: pnpm test:l3
        env:
          DATABASE_URL: postgres://postgres:testpassword@localhost:55434/ai_coding_team_l3

      - name: Collect metrics
        if: always()
        run: |
          curl -s http://localhost:9100/metrics > l3-metrics.txt || true

      - name: Stop L3 environment
        if: always()
        run: docker compose -f docker-compose.l3.yml down

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: l3-results
          path: |
            testing/l3/results/
            l3-metrics.txt

  # =============================================================================
  # L4 - Adversarial Tests (Manual only)
  # =============================================================================
  l4:
    name: L4 - Adversarial
    runs-on: ubuntu-latest
    needs: l2
    if: github.event.inputs.test_level == 'l4' || github.event.inputs.test_level == 'all'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Start L3 test environment
        run: |
          docker compose -f docker-compose.l3.yml up -d
          sleep 30

      - name: Run L4 Adversarial Tests
        run: pnpm test:l4
        continue-on-error: true  # L4 tests may find issues - that's the point

      - name: Run Chaos Tests
        if: github.event.inputs.include_chaos == 'true'
        run: |
          cd testing/l4/chaos
          npm install
          npm run chaos:short
        continue-on-error: true

      - name: Stop environment
        if: always()
        run: docker compose -f docker-compose.l3.yml down

      - name: Upload findings
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: l4-findings
          path: |
            testing/l4/results/
            **/*.log

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [l0-l1, l2]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary
        run: |
          echo "# Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## L0/L1 - Infrastructure & Tools" >> $GITHUB_STEP_SUMMARY
          if [ -f l0-l1-results/test-results.json ]; then
            cat l0-l1-results/test-results.json | jq -r '.summary // "No summary"' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## L2 - Agent Loop" >> $GITHUB_STEP_SUMMARY
          if [ -f l2-results/test-results.json ]; then
            cat l2-results/test-results.json | jq -r '.summary // "No summary"' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for failures
        run: |
          if [ "${{ needs.l0-l1.result }}" != "success" ]; then
            echo "L0/L1 tests failed"
            exit 1
          fi
          if [ "${{ needs.l2.result }}" != "success" ]; then
            echo "L2 tests failed"
            exit 1
          fi

