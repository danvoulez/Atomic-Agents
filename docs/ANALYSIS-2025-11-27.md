# AnÃ¡lise Profunda - Estado do Projeto

> **Data**: 2025-11-27  
> **Status**: AnÃ¡lise comparativa entre planejamento e implementaÃ§Ã£o

---

## 1. O QUE FOI PLANEJADO (docs/_archive/plan.md)

### 1.1 Os 4 Pilares Fundamentais

| Pilar | DescriÃ§Ã£o | Status |
|-------|-----------|--------|
| **Ambient** | ECS Fargate com workers mechanic/genius que escalam 0-N | ğŸŸ¡ Terraform existe, nÃ£o deployado |
| **Source of Truth** | PostgreSQL append-only (jobs, events, ledger) | âœ… Schema bÃ¡sico implementado |
| **Tools** | READ_ONLY, MUTATING, META com contratos claros | ğŸŸ¡ Estrutura existe, maioria sÃ£o stubs |
| **Surveillance** | Eventos, mÃ©tricas, avaliaÃ§Ãµes por job | ğŸŸ¡ Parcialmente implementado |

### 1.2 TDLN Machinery (Rust)

| Crate | PropÃ³sito | Status |
|-------|-----------|--------|
| `logline` | Parser da linguagem LogLine | âœ… Compila, testes passam |
| `tdln-in` | NL â†’ LogLine compiler | âœ… Compila, testes passam |
| `tdln-out` | JSON â†’ NL renderer | âœ… Compila, testes passam |
| `tdln-policy` | Enforcement de regras | âœ… Compila |
| `tdln-quality` | Quality gates | âœ… Compila, testes passam |
| `tdln-truthpack` | Provenance/Merkle | âœ… Compila |
| `napi-bindings` | Node.js bindings | âœ… Compila, .node gerado |

**Rust estÃ¡ sÃ³lido**: `cargo test` passa com todos os testes.

### 1.3 Agentes Planejados

| Agente | FunÃ§Ã£o | Status |
|--------|--------|--------|
| Coordinator | Roteamento, chat | ğŸŸ¡ Estrutura existe, sem LLM |
| Planner | AnÃ¡lise, planejamento | ğŸŸ¡ Estrutura existe, sem LLM |
| Builder | CÃ³digo, testes | ğŸŸ¡ Estrutura existe, sem LLM |
| Reviewer | Code review | ğŸŸ¡ Estrutura existe, sem LLM |
| Evaluator | Scoring pÃ³s-job | ğŸŸ¡ Estrutura existe, sem LLM |
| Watcher | Pattern detection | ğŸŸ¡ Estrutura existe, sem LLM |

### 1.4 Testing Strategy (5 nÃ­veis)

| NÃ­vel | Foco | Status |
|-------|------|--------|
| L0 | Infra/Ambient | âœ… Testes bÃ¡sicos existem |
| L1 | Tools unitÃ¡rios | ğŸŸ¡ Alguns testes existem |
| L2 | Agent loop (job Ãºnico) | âŒ Precisa LLM funcionando |
| L3 | E2E (mÃºltiplos jobs) | âŒ NÃ£o implementado |
| L4 | Battle/Red Team | âŒ NÃ£o implementado |

---

## 2. ESTADO ATUAL DA CODEBASE

### 2.1 âœ… O que FUNCIONA

```
âœ… Monorepo estruturado (pnpm + Cargo workspaces)
âœ… 11 Rust crates compilam e passam testes
âœ… NAPI bindings gerando .node funcional
âœ… packages/db com migrations e pool de conexÃµes
âœ… packages/worker com job claiming (SKIP LOCKED)
âœ… packages/dashboard Next.js com Chat UI
âœ… packages/machinery wrapper para Rust
âœ… packages/tools estrutura completa
âœ… GitHub App authentication
âœ… Lab512 server (git local via tunnel)
âœ… AWS architecture documentada
```

### 2.2 âŒ O que estÃ¡ QUEBRADO

```
âŒ packages/agents NÃƒO COMPILA
   - unified.ts com erros de tipos (Vercel AI SDK v5)
   - MODEL_CHARACTERISTICS com `as const` incompatÃ­vel
   - API do SDK mudou (promptTokens â†’ diferente)

âŒ Testes TypeScript falham (build quebrado)

âŒ IntegraÃ§Ã£o LLM nÃ£o funciona end-to-end
```

### 2.3 ğŸŸ¡ O que sÃ£o STUBS (nÃ£o funcionam de verdade)

| Componente | Arquivo | Status |
|------------|---------|--------|
| `search_code` | `tools/read/search_code.ts` | Stub |
| `list_files` | `tools/read/list_files.ts` | Stub |
| `get_repo_state` | `tools/read/get_repo_state.ts` | Stub |
| `apply_patch` | `tools/write/apply_patch.ts` | Stub |
| `run_tests` | `tools/write/run_tests.ts` | Stub |
| `run_lint` | `tools/write/run_lint.ts` | Stub |
| `commit_changes` | `tools/write/commit_changes.ts` | Stub |
| `record_analysis` | `tools/meta/record_analysis.ts` | Stub |
| `create_plan` | `tools/meta/create_plan.ts` | Stub |
| `request_human_review` | `tools/meta/request_human_review.ts` | Stub |

---

## 3. GAPS CRÃTICOS

### 3.1 Gap Principal: LLM Client Unificado

**Problema**: O `unified.ts` foi criado para usar Vercel AI SDK v5, mas a API mudou e o cÃ³digo nÃ£o compila.

**Impacto**: Sem isso, NENHUM agente funciona com LLM real.

**SoluÃ§Ã£o**: Reescrever `unified.ts` ou voltar para clientes individuais (OpenAI, Anthropic).

### 3.2 Gap SecundÃ¡rio: Tools sÃ£o Stubs

**Problema**: A maioria das ferramentas retorna `{ success: true }` sem fazer nada.

**Impacto**: Mesmo com LLM funcionando, os agentes nÃ£o conseguem executar aÃ§Ãµes reais.

### 3.3 Gap TerciÃ¡rio: Testes L2+ nÃ£o existem

**Problema**: NÃ£o hÃ¡ testes que validem o fluxo completo job â†’ agent â†’ tools â†’ result.

---

## 4. PRIORIDADES

### ğŸ”´ CURTO PRAZO (Esta semana)

| # | Tarefa | EsforÃ§o | Bloqueia |
|---|--------|---------|----------|
| 1 | **Corrigir unified.ts** para compilar | 2-4h | Tudo |
| 2 | Build do packages/agents | 30min | Testes |
| 3 | Testar LLM client com chamada real | 1h | Agentes |
| 4 | Rodar 1 teste L2 simples | 2h | ValidaÃ§Ã£o |

**Meta**: Conseguir fazer 1 job simples rodar end-to-end.

### ğŸŸ¡ MÃ‰DIO PRAZO (PrÃ³ximas 2 semanas)

| # | Tarefa | EsforÃ§o |
|---|--------|---------|
| 1 | Implementar tools reais (read_file jÃ¡ funciona) | 3-5 dias |
| 2 | Implementar Planner agent com LLM | 2-3 dias |
| 3 | Implementar Builder agent com LLM | 3-4 dias |
| 4 | Testes L2 para 5 cenÃ¡rios | 2 dias |
| 5 | Dashboard: EventTimeline funcional | 1 dia |

**Meta**: Fazer um bug fix simples end-to-end (issue â†’ PR).

### ğŸŸ¢ LONGO PRAZO (PrÃ³ximo mÃªs)

| # | Tarefa | EsforÃ§o |
|---|--------|---------|
| 1 | Reviewer + Evaluator agents | 3-4 dias |
| 2 | Watcher (pattern detection) | 2-3 dias |
| 3 | Testes L3 (mÃºltiplos jobs) | 2-3 dias |
| 4 | CI/CD (GitHub Actions) | 1-2 dias |
| 5 | Deploy AWS (Terraform) | 3-5 dias |
| 6 | Testes L4 (red team) | 2-3 dias |

**Meta**: Sistema pronto para ~100 jobs reais.

---

## 5. DECISÃ•ES NECESSÃRIAS

### 5.1 Vercel AI SDK vs Clients Individuais

**OpÃ§Ã£o A**: Corrigir unified.ts para usar Vercel AI SDK v5 corretamente
- âœ… Um cliente para todos os providers
- âŒ API instÃ¡vel (mudou desde v4)

**OpÃ§Ã£o B**: Voltar para OpenAI/Anthropic clients individuais
- âœ… APIs estÃ¡veis e documentadas
- âŒ CÃ³digo duplicado

**RecomendaÃ§Ã£o**: OpÃ§Ã£o A, mas com wrapper mais simples que nÃ£o dependa dos tipos internos do SDK.

### 5.2 Prioridade de Tools

Quais ferramentas implementar primeiro:

1. **search_code** - essencial para Planner encontrar cÃ³digo
2. **apply_patch** - essencial para Builder fazer mudanÃ§as
3. **run_tests** - essencial para validar mudanÃ§as
4. **commit_changes** - essencial para salvar trabalho

### 5.3 Modo de Testes

**Mock LLM** vs **Real LLM** para desenvolvimento:

- Usar **Mock LLM** para testes automatizados (L1, L2)
- Usar **Real LLM** para validaÃ§Ã£o manual e L4

---

## 6. PRÃ“XIMO PASSO IMEDIATO

```bash
# 1. Corrigir unified.ts
# 2. Rebuild
pnpm --filter @ai-coding-team/agents build

# 3. Testar LLM
pnpm test --filter @ai-coding-team/agents

# 4. Rodar um L2
USE_REAL_LLM=true pnpm test:l2
```

---

## 7. MÃ‰TRICAS DE SUCESSO

| Milestone | CritÃ©rio | Prazo |
|-----------|----------|-------|
| M1 | Build passa, LLM client funciona | Esta semana |
| M2 | 1 job bug-fix completo | 2 semanas |
| M3 | 10 jobs mechanic bem-sucedidos | 3 semanas |
| M4 | Deploy AWS funcionando | 4 semanas |
| M5 | 100 jobs reais | 6 semanas |

---

*Documento gerado para tracking de progresso. Atualizar semanalmente.*



